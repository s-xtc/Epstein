<!DOCTYPE html>
<html>
<head>
<title>Sinister Chat</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin: 0; 
    padding: 0; 
    display: flex; 
    height: 100vh; 
    background-color: #121212;
    color: #e0e0e0;
  }
  
  /* Sidebar */
  .sidebar { 
    width: 320px; 
    background: #1e1e1e; 
    border-right: 1px solid #2d2d2d; 
    display: flex; 
    flex-direction: column; 
  }
  .sidebar-header { 
    padding: 15px; 
    border-bottom: 1px solid #2d2d2d; 
  }
  .sidebar-header h3 { 
    margin: 0 0 15px 0; 
    color: #ffffff; 
    font-size: 18px;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-align: center;
  }
  
  /* User Profile in Sidebar */
  .user-profile { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 15px; 
    padding: 10px;
    background: #252525;
    border: 1px solid #2d2d2d;
  }
  .pfp-avatar { 
    width: 45px; 
    height: 45px; 
    background: #333; 
    background-size: cover; 
    background-position: center; 
    border: 2px solid #444; 
    cursor: pointer; 
    flex-shrink: 0;
    border-radius: 50%;
  }
  .user-info { 
    flex: 1;
    overflow: hidden;
  }
  .user-name { 
    font-weight: 600; 
    color: #ffffff;
    margin-bottom: 3px;
    font-size: 14px;
  }
  .user-status { 
    font-size: 0.75em; 
    color: #4CAF50; 
  }
  
  /* Sidebar Sections */
  .sidebar-section { 
    margin-bottom: 15px; 
  }
  .section-title { 
    padding: 10px 15px; 
    background: #252525; 
    color: #cccccc; 
    font-size: 0.85em; 
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #2d2d2d;
  }
  
  /* Buttons */
  .sidebar-buttons { 
    display: flex; 
    gap: 5px; 
    padding: 0 15px 15px 15px;
    border-bottom: 1px solid #2d2d2d;
  }
  button {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .sidebar-buttons button { 
    flex: 1; 
    min-width: 80px; 
    padding: 8px; 
    background: #2d2d2d; 
    color: #ffffff; 
    border: 1px solid #3d3d3d; 
    cursor: pointer; 
    font-size: 0.9em; 
    transition: background-color 0.2s;
  }
  .sidebar-buttons button:hover { 
    background: #3d3d3d; 
  }
  .sidebar-buttons .logout-btn { 
    background: #5a1a1a; 
    border-color: #6a2a2a;
  }
  .sidebar-buttons .logout-btn:hover { 
    background: #6a2a2a; 
  }
  
  /* Chat Lists */
  .chats-list { 
    flex: 1; 
    overflow-y: auto; 
  }
  .chat-type-title {
    padding: 8px 15px;
    background: #252525;
    color: #aaaaaa;
    font-size: 0.8em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #2d2d2d;
  }
  .chat-item { 
    padding: 12px 15px; 
    background: transparent; 
    cursor: pointer; 
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 1px solid #252525;
  }
  .chat-item:hover { 
    background: #252525; 
  }
  .chat-item.active { 
    background: #1a3d1a; 
    border-left: 3px solid #4CAF50; 
  }
  .chat-item-avatar { 
    width: 35px; 
    height: 35px; 
    background: #333; 
    background-size: cover; 
    flex-shrink: 0;
    border-radius: 50%;
  }
  .chat-item-info {
    flex: 1;
    min-width: 0;
  }
  .chat-item-header { 
    display: flex; 
    align-items: center; 
    justify-content: space-between;
    margin-bottom: 3px; 
  }
  .chat-item-name { 
    font-weight: 600; 
    color: #ffffff;
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .chat-item-time { 
    font-size: 0.7em; 
    color: #777; 
  }
  .chat-item-preview { 
    font-size: 0.85em; 
    color: #aaa; 
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .unread-badge {
    background: #4CAF50;
    color: white;
    font-size: 0.7em;
    padding: 2px 6px;
    border-radius: 10px;
    margin-left: auto;
  }
  
  /* Main Chat Area */
  .chat-section { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
  }
  .chat-header { 
    padding: 15px; 
    border-bottom: 1px solid #2d2d2d; 
    background: #1a1a1a; 
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .chat-header-avatar {
    width: 40px;
    height: 40px;
    background: #333;
    background-size: cover;
    border-radius: 50%;
  }
  .chat-header-info {
    flex: 1;
  }
  .chat-header h2 { 
    margin: 0 0 3px 0; 
    color: #ffffff;
    font-size: 16px;
  }
  .chat-header-status { 
    font-size: 0.8em; 
    color: #4CAF50; 
  }
  
  /* Messages Area */
  .messages-area { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    background: #121212;
  }
  #chat { 
    flex: 1; 
    border: none; 
    overflow-y: auto; 
    padding: 15px; 
    background: #0f0f0f; 
    margin: 0;
    list-style: none;
  }
  
  /* Message Items */
  #chat li { 
    margin: 12px 0; 
    padding: 12px; 
    background: #1a1a1a; 
    border-left: 3px solid #3d3d3d; 
    transition: background-color 0.2s;
    display: flex;
    gap: 10px;
  }
  .message-avatar {
    width: 35px;
    height: 35px;
    background: #333;
    background-size: cover;
    flex-shrink: 0;
    border-radius: 50%;
  }
  .message-content {
    flex: 1;
    min-width: 0;
  }
  .message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 5px;
  }
  .username { 
    font-weight: 600; 
    color: #4dabf7; 
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .username-pfp {
    width: 20px;
    height: 20px;
    background: #333;
    background-size: cover;
    border-radius: 50%;
    display: inline-block;
    vertical-align: middle;
  }
  .timestamp { 
    font-size: 0.75em; 
    color: #777; 
    margin-left: auto;
  }
  .typing { 
    font-style: italic; 
    color: #777; 
    padding: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .event { 
    background: #1a2d1a; 
    border-left-color: #2e7d32; 
    font-size: 0.85em; 
    color: #aaa; 
    text-align: center;
    justify-content: center;
  }
  
  /* Input Area */
  .input-area { 
    display: flex; 
    gap: 5px; 
    padding: 15px;
    background: #1a1a1a;
    border-top: 1px solid #2d2d2d;
  }
  #msg { 
    flex: 1; 
    padding: 12px; 
    border: 1px solid #2d2d2d; 
    background: #252525; 
    color: #e0e0e0; 
    font-size: 14px;
  }
  #msg::placeholder {
    color: #777;
  }
  .input-area button { 
    padding: 12px 20px; 
    background: #2d2d2d; 
    color: white; 
    border: 1px solid #3d3d3d; 
    cursor: pointer; 
    font-weight: 600;
    transition: background-color 0.2s;
  }
  .input-area button:hover { 
    background: #3d3d3d; 
  }
  
  /* Status */
  .status { 
    font-size: 0.85em; 
    padding: 10px 15px; 
    background: #1a1a1a;
    border-top: 1px solid #2d2d2d;
  }
  .status.error { 
    color: #f44336; 
    background: #2a1a1a;
  }
  .status.ok { 
    color: #4CAF50; 
    background: #1a2a1a;
  }
  
  /* Modal */
  .modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.8); 
    z-index: 999; 
  }
  .modal.active { 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  .modal-content { 
    background: #1e1e1e; 
    padding: 20px; 
    border: 1px solid #2d2d2d; 
    width: 90%; 
    max-width: 400px; 
    max-height: 80vh; 
    overflow-y: auto; 
  }
  .modal-header { 
    font-size: 1.2em; 
    font-weight: 600; 
    margin-bottom: 15px; 
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .form-group { 
    margin-bottom: 15px; 
  }
  .form-group label { 
    display: block; 
    margin-bottom: 5px; 
    font-weight: 600; 
    color: #cccccc;
  }
  .form-group input { 
    width: 100%; 
    padding: 10px; 
    border: 1px solid #2d2d2d; 
    background: #252525; 
    color: #e0e0e0; 
    box-sizing: border-box; 
  }
  .form-group input[type="file"] { 
    padding: 8px; 
  }
  .preview-pfp { 
    width: 80px; 
    height: 80px; 
    background: #333; 
    background-size: cover; 
    background-position: center; 
    margin: 10px auto; 
    border: 2px solid #444;
    border-radius: 50%;
  }
  .modal-buttons { 
    display: flex; 
    gap: 10px; 
    justify-content: flex-end; 
    margin-top: 20px; 
  }
  .modal-buttons button { 
    margin: 0; 
    padding: 10px 15px; 
  }
  .btn-cancel { 
    background: #333; 
    color: white; 
    border: 1px solid #444; 
    cursor: pointer; 
  }
  .btn-cancel:hover { 
    background: #444; 
  }
  .modal-tabs { 
    display: flex; 
    gap: 0; 
    margin-bottom: 15px; 
    border-bottom: 1px solid #2d2d2d; 
  }
  .modal-tab { 
    padding: 10px 15px; 
    cursor: pointer; 
    background: #252525; 
    border: 1px solid #2d2d2d; 
    border-bottom: none;
    color: #aaa;
    transition: all 0.2s;
  }
  .modal-tab.active { 
    background: #1e1e1e; 
    color: #ffffff; 
    border-bottom: 1px solid #1e1e1e;
    margin-bottom: -1px;
  }
  .tab-content { 
    display: none; 
  }
  .tab-content.active { 
    display: block; 
  }
  .search-results { 
    border: 1px solid #2d2d2d; 
    max-height: 200px; 
    overflow-y: auto; 
    margin-top: 10px; 
    background: #252525;
  }
  .search-result-item { 
    padding: 12px; 
    border-bottom: 1px solid #333; 
    cursor: pointer; 
    color: #cccccc;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .search-result-item:hover { 
    background: #2d2d2d; 
  }
  .search-result-avatar {
    width: 30px;
    height: 30px;
    background: #333;
    background-size: cover;
    border-radius: 50%;
  }
  
  /* Scrollbar Styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #1a1a1a;
  }
  ::-webkit-scrollbar-thumb {
    background: #333;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #444;
  }
  
  /* Private Chat List */
  .private-chats-list {
    max-height: 250px;
    overflow-y: auto;
  }
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <h3>Sinister Chat</h3>
    <div class="user-profile">
      <span id="pfp-avatar" class="pfp-avatar" onclick="openProfileModal()"></span>
      <div class="user-info">
        <div class="user-name" id="current-user">Loading...</div>
        <div class="user-status" id="user-status">Online</div>
      </div>
    </div>
    
    <div class="sidebar-buttons">
      <button onclick="openProfileModal()">Settings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  
  <!-- Public Chats Section -->
  <div class="sidebar-section">
    <div class="section-title">Public Rooms</div>
    <div class="chats-list">
      <div class="chat-item active" onclick="switchToChat('main', 'Main Chat')">
        <div class="chat-item-avatar" id="main-chat-avatar"></div>
        <div class="chat-item-info">
          <div class="chat-item-header">
            <div class="chat-item-name">Main Chat</div>
            <div class="chat-item-time" id="main-chat-time">Just now</div>
          </div>
          <div class="chat-item-preview" id="main-chat-preview">Welcome to Sinister Chat</div>
        </div>
        <div class="unread-badge" id="main-unread" style="display: none;">0</div>
      </div>
    </div>
  </div>
  
  <!-- Private Chats Section -->
  <div class="sidebar-section">
    <div class="section-title">Private Chats</div>
    <div class="private-chats-list" id="privateChatsList">
      <!-- Private chats will be loaded here -->
      <div class="chat-item" onclick="switchToPrivateChat('user1', 'Shadow User')">
        <div class="chat-item-avatar" style="background-image: url('https://i.pravatar.cc/150?img=1')"></div>
        <div class="chat-item-info">
          <div class="chat-item-header">
            <div class="chat-item-name">Shadow User</div>
            <div class="chat-item-time">2:30 PM</div>
          </div>
          <div class="chat-item-preview">Hey there! How are you?</div>
        </div>
        <div class="unread-badge">3</div>
      </div>
      <div class="chat-item" onclick="switchToPrivateChat('user2', 'Dark Messenger')">
        <div class="chat-item-avatar" style="background-image: url('https://i.pravatar.cc/150?img=2')"></div>
        <div class="chat-item-info">
          <div class="chat-item-header">
            <div class="chat-item-name">Dark Messenger</div>
            <div class="chat-item-time">Yesterday</div>
          </div>
          <div class="chat-item-preview">Did you see the new update?</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Online Users Section -->
  <div class="sidebar-section">
    <div class="section-title">Online Users</div>
    <div class="chats-list" id="onlineUsersList">
      <!-- Online users will be populated here -->
    </div>
  </div>
  
  <div class="status" id="status">Connecting...</div>
</div>

<!-- Main Chat Area -->
<div class="chat-section">
  <div class="chat-header">
    <div class="chat-header-avatar" id="current-chat-avatar"></div>
    <div class="chat-header-info">
      <h2 id="current-chat-name">Main Chat</h2>
      <div class="chat-header-status" id="current-chat-status">Public Room • <span id="online-count">0</span> online</div>
    </div>
  </div>
  
  <div class="messages-area">
    <ul id="chat"></ul>
    
    <div class="input-area">
      <input id="msg" placeholder="Type a message..." disabled />
      <button id="sendBtn" onclick="send()" disabled>Send</button>
    </div>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Settings</div>
    
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('profile')">Profile</button>
      <button class="modal-tab" onclick="switchTab('password')">Password</button>
      <button class="modal-tab" onclick="switchTab('private')">Private Chat</button>
    </div>
    
    <!-- Profile Tab -->
    <div id="profile" class="tab-content active">
      <div class="preview-pfp" id="previewPfp"></div>
      <div class="form-group">
        <label for="editUsername">Username</label>
        <input id="editUsername" type="text" placeholder="Enter new username" />
      </div>
      <div class="form-group">
        <label for="editPfp">Profile Picture (PNG/JPG)</label>
        <input id="editPfp" type="file" accept="image/*" onchange="previewImage()" />
      </div>
    </div>
    
    <!-- Password Tab -->
    <div id="password" class="tab-content">
      <div class="form-group">
        <label for="oldPassword">Old Password</label>
        <input id="oldPassword" type="password" placeholder="Enter old password" />
      </div>
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input id="newPassword" type="password" placeholder="Enter new password" />
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input id="confirmPassword" type="password" placeholder="Confirm new password" />
      </div>
    </div>
    
    <!-- Private Chat Tab -->
    <div id="private" class="tab-content">
      <div class="form-group">
        <label for="searchUser">Search User</label>
        <input id="searchUser" type="text" placeholder="Type username..." onkeyup="searchUsers()" />
      </div>
      <div id="searchResults" class="search-results"></div>
    </div>
    
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeProfileModal()">Close</button>
      <button id="actionBtn" onclick="handleModalAction()">Save</button>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const msg = document.getElementById('msg');
const statusEl = document.getElementById('status');
const currentUserEl = document.getElementById('current-user');
const pfpAvatarEl = document.getElementById('pfp-avatar');
const onlineCountEl = document.getElementById('online-count');
const currentChatNameEl = document.getElementById('current-chat-name');
const currentChatAvatarEl = document.getElementById('current-chat-avatar');
const privateChatsList = document.getElementById('privateChatsList');
const onlineUsersList = document.getElementById('onlineUsersList');

let currentUsername = 'Anonymous';
let currentPfp = '';
let typingTimeout = null;
let ws = null;
let currentChatId = 'main';
let onlineUsers = [];
let privateChats = [];

// Check auth
const token = localStorage.getItem('token');
const savedUsername = localStorage.getItem('username');
const savedPfp = localStorage.getItem('pfp');

if (!token) {
  window.location.href = '/login.html';
}

currentUsername = savedUsername || 'Anonymous';
currentPfp = savedPfp || '';
currentUserEl.textContent = currentUsername;
if (currentPfp) {
  pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;
}

const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';

function connectWS() {
  try {
    const url = `${wsProtocol}://${location.host}/ws?token=${encodeURIComponent(token)}`;
    console.log('Connecting to:', url);
    ws = new WebSocket(url);

    ws.onopen = () => {
      console.log('WebSocket connected');
      statusEl.textContent = '✓ Connected';
      statusEl.className = 'status ok';
      msg.disabled = false;
      document.getElementById('sendBtn').disabled = false;
      loadMessages();
      loadOnlineUsers();
      loadPrivateChats();
    };

    ws.onmessage = e => {
      try {
        const data = JSON.parse(e.data);
        const type = data.type;
        const info = data.data;

        if (type === 'message') {
          addMessage(info.username, info.text, info.timestamp, info.pfp);
          updateChatPreview(info.username, info.text, info.timestamp);
        } else if (type === 'user_typing') {
          showTyping(info.username);
        } else if (type === 'user_joined') {
          addEvent(`${info.username} joined the chat`);
          updateOnlineCount(info.count);
          addOnlineUser(info.username, info.pfp);
        } else if (type === 'user_left') {
          addEvent(`${info.username} left the chat`);
          updateOnlineCount(info.count);
          removeOnlineUser(info.username);
        } else if (type === 'username_changed') {
          addEvent(`${info.old} is now ${info.new}`);
        } else if (type === 'private_message') {
          handlePrivateMessage(info);
        }
      } catch (err) {
        console.error('Error parsing message:', err);
      }
    };

    ws.onclose = () => {
      console.log('WebSocket closed');
      statusEl.textContent = '✗ Disconnected';
      statusEl.className = 'status error';
      msg.disabled = true;
      document.getElementById('sendBtn').disabled = true;
    };

    ws.onerror = (e) => {
      console.error('WebSocket error:', e);
      statusEl.textContent = '✗ Connection error: ' + (e.message || 'unknown');
      statusEl.className = 'status error';
    };
  } catch (e) {
    console.error('Failed to create WebSocket:', e);
    statusEl.textContent = '✗ Connection failed: ' + e.message;
    statusEl.className = 'status error';
  }
}

function addMessage(user, text, timestamp, userPfp = '') {
  const li = document.createElement('li');
  const time = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
  const pfpHTML = userPfp ? `<div class="message-avatar" style="background-image: url('${userPfp}')"></div>` : '<div class="message-avatar"></div>';
  const smallPfp = userPfp ? `<span class="username-pfp" style="background-image: url('${userPfp}')"></span>` : '';
  
  li.innerHTML = `
    ${pfpHTML}
    <div class="message-content">
      <div class="message-header">
        <span class="username">${smallPfp}${user}</span>
        <span class="timestamp">${time}</span>
      </div>
      <div>${text}</div>
    </div>
  `;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
}

function addEvent(text) {
  const li = document.createElement('li');
  li.className = 'event';
  li.textContent = text;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
}

function showTyping(user) {
  const existing = Array.from(chat.children).find(li => li.classList.contains('typing'));
  if (existing) existing.remove();
  
  const li = document.createElement('li');
  li.className = 'typing';
  li.innerHTML = `<div class="message-avatar"></div><div class="message-content">${user} is typing...</div>`;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
  
  setTimeout(() => li.remove(), 2000);
}

async function loadMessages() {
  try {
    const res = await fetch('/messages');
    if (!res.ok) {
      console.error('Failed to load messages:', res.status);
      return;
    }
    const data = await res.json();
    chat.innerHTML = '';
    data.forEach(m => {
      addMessage(m.username, m.text, '', m.pfp);
    });
    chat.scrollTop = chat.scrollHeight;
  } catch (e) {
    console.error('Error loading messages:', e);
  }
}

async function loadOnlineUsers() {
  try {
    const res = await fetch('/online-users');
    if (!res.ok) return;
    const users = await res.json();
    onlineUsers = users;
    updateOnlineUsersList();
    updateOnlineCount(users.length);
  } catch (e) {
    console.error('Error loading online users:', e);
  }
}

async function loadPrivateChats() {
  try {
    const res = await fetch('/private-chats');
    if (!res.ok) return;
    const chats = await res.json();
    privateChats = chats;
    updatePrivateChatsList();
  } catch (e) {
    console.error('Error loading private chats:', e);
  }
}

function updateOnlineUsersList() {
  onlineUsersList.innerHTML = '';
  onlineUsers.forEach(user => {
    const item = document.createElement('div');
    item.className = 'chat-item';
    item.onclick = () => startPrivateChat(user.username);
    item.innerHTML = `
      <div class="chat-item-avatar" style="background-image: url('${user.pfp || ''}')"></div>
      <div class="chat-item-info">
        <div class="chat-item-header">
          <div class="chat-item-name">${user.username}</div>
          <div class="chat-item-time">Online</div>
        </div>
        <div class="chat-item-preview">Click to start chat</div>
      </div>
    `;
    onlineUsersList.appendChild(item);
  });
}

function updatePrivateChatsList() {
  privateChatsList.innerHTML = '';
  privateChats.forEach(chat => {
    const item = document.createElement('div');
    item.className = 'chat-item';
    item.onclick = () => switchToPrivateChat(chat.with_user_id, chat.with_username);
    item.innerHTML = `
      <div class="chat-item-avatar" style="background-image: url('${chat.with_pfp || ''}')"></div>
      <div class="chat-item-info">
        <div class="chat-item-header">
          <div class="chat-item-name">${chat.with_username}</div>
          <div class="chat-item-time">${formatTime(chat.last_message_time)}</div>
        </div>
        <div class="chat-item-preview">${chat.last_message || 'No messages yet'}</div>
      </div>
      ${chat.unread_count > 0 ? `<div class="unread-badge">${chat.unread_count}</div>` : ''}
    `;
    privateChatsList.appendChild(item);
  });
}

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  
  if (diff < 86400000) {
    return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  } else if (diff < 604800000) {
    return date.toLocaleDateString([], {weekday: 'short'});
  } else {
    return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
  }
}

function updateChatPreview(username, text, timestamp) {
  if (currentChatId === 'main') {
    document.getElementById('main-chat-preview').textContent = `${username}: ${text}`;
    document.getElementById('main-chat-time').textContent = formatTime(timestamp);
  }
}

function updateOnlineCount(count) {
  onlineCountEl.textContent = count;
}

function addOnlineUser(username, pfp) {
  if (!onlineUsers.find(u => u.username === username)) {
    onlineUsers.push({username, pfp});
    updateOnlineUsersList();
  }
}

function removeOnlineUser(username) {
  onlineUsers = onlineUsers.filter(u => u.username !== username);
  updateOnlineUsersList();
}

function startPrivateChat(username) {
  openPrivateChat(username);
}

function switchToChat(chatId, chatName) {
  currentChatId = chatId;
  currentChatNameEl.textContent = chatName;
  document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
  event.target.closest('.chat-item').classList.add('active');
  
  if (chatId === 'main') {
    loadMessages();
    document.getElementById('current-chat-status').textContent = `Public Room • ${onlineUsers.length} online`;
  }
}

function switchToPrivateChat(userId, username) {
  currentChatId = `private_${userId}`;
  currentChatNameEl.textContent = username || 'Private Chat';
  document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));
  event.target.closest('.chat-item').classList.add('active');
  
  chat.innerHTML = '';
  addEvent(`Private chat with ${username || 'user'}`);
  document.getElementById('current-chat-status').textContent = 'Private Chat • Secure';
}

function send() {
  if (!msg.value.trim()) {
    return;
  }
  
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    statusEl.textContent = '✗ Not connected';
    statusEl.className = 'status error';
    return;
  }
  
  const messageData = {
    type: currentChatId.startsWith('private_') ? 'private_message' : 'message',
    content: msg.value,
    chat_id: currentChatId
  };
  
  ws.send(JSON.stringify(messageData));
  msg.value = '';
  
  if (typingTimeout) clearTimeout(typingTimeout);
}

msg.addEventListener('input', () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'typing' }));
  }
  
  if (typingTimeout) clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {}, 2000);
});

msg.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') send();
});

let currentTab = 'profile';

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  event.target.classList.add('active');
  
  const btn = document.getElementById('actionBtn');
  if (tab === 'profile') {
    btn.textContent = 'Save';
  } else if (tab === 'password') {
    btn.textContent = 'Change Password';
  } else {
    btn.style.display = 'none';
  }
}

function openProfileModal() {
  const modal = document.getElementById('profileModal');
  modal.classList.add('active');
  document.getElementById('editUsername').value = currentUsername;
  const preview = document.getElementById('previewPfp');
  if (currentPfp) {
    preview.style.backgroundImage = `url('${currentPfp}')`;
  } else {
    preview.style.background = '#333';
  }
}

function closeProfileModal() {
  document.getElementById('profileModal').classList.remove('active');
  document.getElementById('editPfp').value = '';
  document.getElementById('oldPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  document.getElementById('searchUser').value = '';
  document.getElementById('searchResults').innerHTML = '';
  document.getElementById('actionBtn').style.display = 'block';
}

function previewImage() {
  const fileInput = document.getElementById('editPfp');
  const preview = document.getElementById('previewPfp');
  const file = fileInput.files[0];
  
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.style.backgroundImage = `url('${e.target.result}')`;
    };
    reader.readAsDataURL(file);
  }
}

async function searchUsers() {
  const q = document.getElementById('searchUser').value.trim();
  if (!q || q.length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  
  try {
    const res = await fetch(`/search-users?q=${encodeURIComponent(q)}&token=${encodeURIComponent(token)}`);
    if (!res.ok) return;
    const results = await res.json();
    
    const resultsEl = document.getElementById('searchResults');
    resultsEl.innerHTML = '';
    results.forEach(user => {
      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.innerHTML = `
        <div class="search-result-avatar" style="background-image: url('${user.pfp || ''}')"></div>
        <div>${user.username}</div>
      `;
      item.onclick = () => openPrivateChat(user.username);
      resultsEl.appendChild(item);
    });
  } catch (e) {
    console.error(e);
  }
}

async function openPrivateChat(withUser) {
  try {
    const res = await fetch('/private-chats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, with_user: withUser })
    });
    if (!res.ok) {
      alert('Error creating chat');
      return;
    }
    const data = await res.json();
    
    privateChats.push({
      with_user_id: data.user_id,
      with_username: withUser,
      with_pfp: data.pfp,
      last_message: 'Chat started',
      last_message_time: new Date().toISOString(),
      unread_count: 0
    });
    
    updatePrivateChatsList();
    closeProfileModal();
    alert(`Private chat started with ${withUser}!`);
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function handlePrivateMessage(info) {
  let chat = privateChats.find(c => c.with_user_id === info.from_user_id);
  if (!chat) {
    chat = {
      with_user_id: info.from_user_id,
      with_username: info.from_username,
      with_pfp: info.from_pfp,
      last_message: info.text,
      last_message_time: info.timestamp,
      unread_count: 1
    };
    privateChats.push(chat);
  } else {
    chat.last_message = info.text;
    chat.last_message_time = info.timestamp;
    chat.unread_count = (chat.unread_count || 0) + 1;
  }
  
  updatePrivateChatsList();
  
  if (currentChatId === `private_${info.from_user_id}`) {
    addMessage(info.from_username, info.text, info.timestamp, info.from_pfp);
    chat.unread_count = 0;
    updatePrivateChatsList();
  }
}

async function handleModalAction() {
  if (currentTab === 'profile') {
    await saveProfile();
  } else if (currentTab === 'password') {
    await changePassword();
  }
}

async function saveProfile() {
  const newUsername = document.getElementById('editUsername').value.trim();
  const fileInput = document.getElementById('editPfp');
  let pfpData = currentPfp;
  
  if (fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      pfpData = e.target.result;
      await doSaveProfile(newUsername, pfpData);
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    await doSaveProfile(newUsername, pfpData);
  }
}

async function doSaveProfile(newUsername, pfpData) {
  try {
    const res = await fetch('/profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, username: newUsername || null, pfp: pfpData || null })
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('Error: ' + (err.detail || 'Failed to update profile'));
      return;
    }
    
    const data = await res.json();
    
    localStorage.setItem('token', data.access_token);
    localStorage.setItem('username', data.username);
    if (data.pfp) localStorage.setItem('pfp', data.pfp);
    
    currentUsername = data.username;
    currentPfp = data.pfp || '';
    currentUserEl.textContent = currentUsername;
    if (currentPfp) {
      pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;
    }
    
    closeProfileModal();
    alert('Profile updated successfully!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function changePassword() {
  const oldPw = document.getElementById('oldPassword').value;
  const newPw = document.getElementById('newPassword').value;
  const confirmPw = document.getElementById('confirmPassword').value;
  
  if (!oldPw || !newPw || !confirmPw) {
    alert('Please fill all password fields');
    return;
  }
  
  if (newPw !== confirmPw) {
    alert('New passwords do not match');
    return;
  }
  
  if (newPw.length < 6) {
    alert('New password must be at least 6 characters');
    return;
  }
  
  try {
    const res = await fetch('/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, old_password: oldPw, new_password: newPw })
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('Error: ' + (err.detail || 'Failed to change password'));
      return;
    }
    
    document.getElementById('oldPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    alert('Password changed successfully!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('username');
  localStorage.removeItem('pfp');
  if (ws) ws.close();
  window.location.href = '/login.html';
}

function initSampleData() {
  document.getElementById('main-chat-avatar').style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/2455/2455300.png")';
  currentChatAvatarEl.style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/2455/2455300.png")';
  
  setTimeout(() => {
    const sampleUsers = [
      { username: 'ShadowUser', pfp: 'https://i.pravatar.cc/150?img=1' },
      { username: 'DarkKnight', pfp: 'https://i.pravatar.cc/150?img=3' },
      { username: 'Midnight', pfp: 'https://i.pravatar.cc/150?img=4' },
      { username: 'Phantom', pfp: 'https://i.pravatar.cc/150?img=5' },
      { username: 'Viper', pfp: 'https://i.pravatar.cc/150?img=6' }
    ];
    
    sampleUsers.forEach(user => {
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.onclick = () => startPrivateChat(user.username);
      item.innerHTML = `
        <div class="chat-item-avatar" style="background-image: url('${user.pfp}')"></div>
        <div class="chat-item-info">
          <div class="chat-item-header">
            <div class="chat-item-name">${user.username}</div>
            <div class="chat-item-time">Online</div>
          </div>
          <div class="chat-item-preview">Click to start chat</div>
        </div>
      `;
      onlineUsersList.appendChild(item);
    });
    
    updateOnlineCount(sampleUsers.length + 1);
  }, 1000);
}

connectWS();
initSampleData();
</script>
</body>
</html>
