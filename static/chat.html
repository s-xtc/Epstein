<!DOCTYPE html>
<html>
<head>
<title>Chat Room</title>
<style>
  * { box-sizing: border-box; }
  body { font-family: Arial; margin: 0; padding: 0; display: flex; height: 100vh; background: #f0f2f5; }
  
  /* Sidebar & Layout */
  .sidebar { width: 300px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
  .chat-section { flex: 1; display: flex; flex-direction: column; height: 100vh; }
  
  /* Header */
  .header { background: #0078d4; color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
  .user-info { display: flex; align-items: center; gap: 10px; }
  
  /* Avatars */
  .pfp-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; background-size: cover; background-position: center; border: 2px solid #fff; cursor: pointer; flex-shrink: 0; display: inline-block; vertical-align: middle; }
  .preview-pfp { width: 80px; height: 80px; border-radius: 50%; background: #ddd; background-size: cover; background-position: center; margin: 10px auto; border: 2px solid #0078d4; }

  /* Chat Messages Area */
  #chat { flex: 1; border: none; overflow-y: auto; padding: 20px; background: #fff; margin: 0; list-style: none; }
  li { margin-bottom: 12px; padding: 10px; background: #f9f9f9; border-radius: 8px; border-left: 4px solid #0078d4; max-width: 80%; }
  .username { font-weight: bold; color: #0078d4; cursor: pointer; text-decoration: none; }
  .username:hover { text-decoration: underline; }
  .timestamp { font-size: 0.7em; color: #999; margin-left: 10px; }
  .event { background: #e8f5e9; border-left-color: #4caf50; font-size: 0.85em; color: #555; text-align: center; border-left: none; margin: 10px auto; width: fit-content; }
  .typing { font-style: italic; color: #aaa; background: none; border: none; }

  /* Input Area */
  .input-area { padding: 15px; background: white; border-top: 1px solid #ddd; display: flex; gap: 10px; }
  #msg { flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 20px; outline: none; }
  .btn-send { padding: 0 20px; background: #0078d4; color: white; border: none; border-radius: 20px; cursor: pointer; }
  
  /* Status Bar */
  .status { font-size: 0.8em; padding: 5px 15px; background: #eee; border-top: 1px solid #ccc; }
  .status.ok { color: #2e7d32; }
  .status.error { color: #d32f2f; }

  /* Modals */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 999; align-items: center; justify-content: center; }
  .modal.active { display: flex; }
  .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 350px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
  .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
  .btn-cancel { background: #e0e0e0; color: #333; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
  .btn-save { background: #0078d4; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }

  /* Tabs */
  .modal-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #eee; }
  .modal-tab { padding: 8px 12px; cursor: pointer; border: none; background: none; }
  .modal-tab.active { border-bottom: 2px solid #0078d4; color: #0078d4; font-weight: bold; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
</style>
</head>
<body>

<div class="chat-section">
  <div class="header">
    <div style="display: flex; align-items: center; gap: 10px;">
      <div id="pfp-avatar" class="pfp-avatar" onclick="openProfileModal()"></div>
      <div>
        <div style="font-weight: bold;" id="current-user">Loading...</div>
        <div style="font-size: 0.75em; opacity: 0.8;">Online: <span id="count">0</span></div>
      </div>
    </div>
    <div>
      <button onclick="openProfileModal()" style="padding: 5px 10px; cursor: pointer;">Settings</button>
      <button onclick="logout()" style="padding: 5px 10px; cursor: pointer; background: #f44336; color: white; border: none;">Logout</button>
    </div>
  </div>

  <ul id="chat"></ul>

  <div class="input-area">
    <input id="msg" placeholder="Type a message..." disabled />
    <button id="sendBtn" class="btn-send" onclick="send()" disabled>Send</button>
  </div>
  <div class="status" id="status">Connecting...</div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-content">
    <div class="modal-tabs">
      <button id="tab-profile" class="modal-tab active" onclick="switchTab('profile')">Profile</button>
      <button id="tab-password" class="modal-tab" onclick="switchTab('password')">Security</button>
      <button id="tab-private" class="modal-tab" onclick="switchTab('private')">Direct</button>
    </div>
    
    <div id="profile" class="tab-content active">
      <div class="preview-pfp" id="previewPfp"></div>
      <div class="form-group">
        <label>Username</label>
        <input id="editUsername" type="text" />
      </div>
      <div class="form-group">
        <label>New Profile Picture</label>
        <input id="editPfp" type="file" accept="image/*" onchange="previewImage()" />
      </div>
    </div>

    <div id="password" class="tab-content">
      <div class="form-group"><label>Old Password</label><input id="oldPassword" type="password" /></div>
      <div class="form-group"><label>New Password</label><input id="newPassword" type="password" /></div>
      <div class="form-group"><label>Confirm</label><input id="confirmPassword" type="password" /></div>
    </div>

    <div id="private" class="tab-content">
      <div class="form-group">
        <label>Find User</label>
        <input id="searchUser" type="text" placeholder="Username..." onkeyup="searchUsers()" />
      </div>
      <div id="searchResults" style="max-height: 150px; overflow-y: auto; border: 1px solid #eee;"></div>
    </div>
    
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeProfileModal()">Close</button>
      <button id="actionBtn" class="btn-save" onclick="handleModalAction()">Save</button>
    </div>
  </div>
</div>

<div id="userInfoModal" class="modal">
  <div class="modal-content" style="max-width: 250px; text-align: center;">
    <div id="userPopupPfp" class="preview-pfp"></div>
    <h3 id="userPopupName" style="margin: 10px 0 5px 0;">Username</h3>
    <p id="userPopupStatus" style="font-size: 0.8em; color: #666; margin-bottom: 20px;">Last online: --</p>
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <button onclick="openPrivateChat(document.getElementById('userPopupName').textContent)" style="background: #4caf50; color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer;">Private Message</button>
      <button class="btn-cancel" onclick="document.getElementById('userInfoModal').classList.remove('active')">Close</button>
    </div>
  </div>
</div>

<script>
const chat = document.getElementById('chat');
const msg = document.getElementById('msg');
const statusEl = document.getElementById('status');
const countEl = document.getElementById('count');
const currentUserEl = document.getElementById('current-user');
const pfpAvatarEl = document.getElementById('pfp-avatar');

let currentUsername = localStorage.getItem('username') || 'Anonymous';
let currentPfp = localStorage.getItem('pfp') || '';
let token = localStorage.getItem('token');
let ws = null;
let currentTab = 'profile';

if (!token) window.location.href = '/login.html';

// Initial UI Setup
currentUserEl.textContent = currentUsername;
if (currentPfp) pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;

function connectWS() {
  const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
  const url = `${wsProtocol}://${location.host}/ws?token=${encodeURIComponent(token)}`;
  ws = new WebSocket(url);

  ws.onopen = () => {
    statusEl.textContent = '✓ Connected';
    statusEl.className = 'status ok';
    msg.disabled = false;
    document.getElementById('sendBtn').disabled = false;
    loadMessages(); // PERSISTENCE FIX: Load history from DB on connect
  };

  ws.onmessage = e => {
    const data = JSON.parse(e.data);
    if (data.type === 'message') addMessage(data.data.username, data.data.text, data.data.timestamp);
    if (data.type === 'user_typing') showTyping(data.data.username);
    if (data.type === 'user_joined' || data.type === 'user_left') {
      addEvent(data.type === 'user_joined' ? `${data.data.username} joined` : `${data.data.username} left`);
      countEl.textContent = data.data.count;
    }
  };

  ws.onclose = () => {
    statusEl.textContent = '✗ Disconnected';
    statusEl.className = 'status error';
    msg.disabled = true;
  };
}

async function loadMessages() {
  try {
    const res = await fetch('/messages');
    if (res.ok) {
      const data = await res.json();
      chat.innerHTML = ''; // Clear UI before populating from database
      data.forEach(m => addMessage(m.username, m.text, m.timestamp));
    }
  } catch (e) { console.error(e); }
}

function addMessage(user, text, timestamp) {
  const li = document.createElement('li');
  const time = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
  
  // USERNAME CLICK FIX: calls showUserMenu
  li.innerHTML = `<span class="username" onclick="showUserMenu('${user}')">${user}:</span> 
                  <span>${text}</span> 
                  <span class="timestamp">${time}</span>`;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
}

// USER POPUP SYSTEM
async function showUserMenu(username) {
  try {
    const res = await fetch(`/user-info?username=${encodeURIComponent(username)}&token=${encodeURIComponent(token)}`);
    const data = await res.json();
    
    document.getElementById('userPopupName').textContent = data.username;
    document.getElementById('userPopupStatus').textContent = data.online ? 'Online' : 'Last seen: ' + (data.last_seen || 'Recently');
    const popupPfp = document.getElementById('userPopupPfp');
    popupPfp.style.backgroundImage = data.pfp ? `url('${data.pfp}')` : 'none';
    popupPfp.style.backgroundColor = data.pfp ? 'transparent' : '#ddd';
    
    document.getElementById('userInfoModal').classList.add('active');
  } catch (e) {
    alert("User: " + username);
  }
}

function send() {
  if (!msg.value.trim() || !ws) return;
  ws.send(JSON.stringify({ type: 'message', content: msg.value }));
  msg.value = '';
}

function addEvent(text) {
  const li = document.createElement('li');
  li.className = 'event';
  li.textContent = text;
  chat.appendChild(li);
}

function showTyping(user) {
  const id = 'typing-' + user;
  if (document.getElementById(id)) return;
  const li = document.createElement('li');
  li.id = id;
  li.className = 'typing';
  li.textContent = `${user} is typing...`;
  chat.appendChild(li);
  setTimeout(() => li.remove(), 2000);
}

// MODAL & PROFILE LOGIC
function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  document.getElementById('actionBtn').style.display = (tab === 'private') ? 'none' : 'block';
}

function openProfileModal() {
  document.getElementById('profileModal').classList.add('active');
  document.getElementById('editUsername').value = currentUsername;
  document.getElementById('previewPfp').style.backgroundImage = currentPfp ? `url('${currentPfp}')` : 'none';
}

function closeProfileModal() {
  document.getElementById('profileModal').classList.remove('active');
}

function previewImage() {
  const file = document.getElementById('editPfp').files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => document.getElementById('previewPfp').style.backgroundImage = `url('${e.target.result}')`;
    reader.readAsDataURL(file);
  }
}

async function handleModalAction() {
  if (currentTab === 'profile') {
    const file = document.getElementById('editPfp').files[0];
    let pfpBase64 = currentPfp;
    
    if (file) {
      const reader = new FileReader();
      reader.onload = async (e) => {
        await saveProfile(document.getElementById('editUsername').value, e.target.result);
      };
      reader.readAsDataURL(file);
    } else {
      await saveProfile(document.getElementById('editUsername').value, pfpBase64);
    }
  } else if (currentTab === 'password') {
    changePassword();
  }
}

async function saveProfile(newUsername, pfpData) {
  const res = await fetch('/profile', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token, username: newUsername, pfp: pfpData })
  });
  if (res.ok) {
    const data = await res.json();
    localStorage.setItem('username', data.username);
    localStorage.setItem('pfp', data.pfp);
    location.reload(); // Simple refresh to sync everything
  }
}

async function openPrivateChat(user) {
  alert("Opening private chat with " + user + " (Function calling internal messenger...)");
  document.getElementById('userInfoModal').classList.remove('active');
  // Logic to switch view to private messenger goes here
}

function logout() {
  localStorage.clear();
  window.location.href = '/login.html';
}

msg.addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });
connectWS();
</script>
</body>
</html>
