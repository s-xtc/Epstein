  const preview = document.getElementById('previewPfp');
  const file = fileInput.files[0];
  
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.style.backgroundImage = `url('${e.target.result}')`;
    };
    reader.readAsDataURL(file);
  }
}

async function searchUsers() {
  const q = document.getElementById('searchUser').value.trim();
  if (!q || q.length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  
  try {
    const res = await fetch(`/search-users?q=${encodeURIComponent(q)}&token=${encodeURIComponent(token)}`);
    if (!res.ok) return;
    const results = await res.json();
    
    const resultsEl = document.getElementById('searchResults');
    resultsEl.innerHTML = '';
    results.forEach(user => {
      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.innerHTML = `
        <div class="search-result-avatar" style="background-image: url('${user.pfp || ''}')"></div>
        <div>${user.username}</div>
      `;
      item.onclick = () => openPrivateChat(user.username);
      resultsEl.appendChild(item);
    });
  } catch (e) {
    console.error(e);
  }
}

async function openPrivateChat(withUser) {
  try {
    const res = await fetch('/private-chats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, with_user: withUser })
    });
    if (!res.ok) {
      alert('Error creating chat');
      return;
    }
    const data = await res.json();
    
    // Add to private chats list
    privateChats.push({
      with_user_id: data.user_id,
      with_username: withUser,
      with_pfp: data.pfp,
      last_message: 'Chat started',
      last_message_time: new Date().toISOString(),
      unread_count: 0
    });
    
    updatePrivateChatsList();
    closeProfileModal();
    alert(`Private chat started with ${withUser}! You can find it in the Private Chats section.`);
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function handlePrivateMessage(info) {
  // Find or create private chat
  let chat = privateChats.find(c => c.with_user_id === info.from_user_id);
  if (!chat) {
    chat = {
      with_user_id: info.from_user_id,
      with_username: info.from_username,
      with_pfp: info.from_pfp,
      last_message: info.text,
      last_message_time: info.timestamp,
      unread_count: 1
    };
    privateChats.push(chat);
  } else {
    chat.last_message = info.text;
    chat.last_message_time = info.timestamp;
    chat.unread_count = (chat.unread_count || 0) + 1;
  }
  
  updatePrivateChatsList();
  
  // If we're currently viewing this private chat, show the message
  if (currentChatId === `private_${info.from_user_id}`) {
    addMessage(info.from_username, info.text, info.timestamp, info.from_pfp);
    chat.unread_count = 0;
    updatePrivateChatsList();
  }
}

async function handleModalAction() {
  if (currentTab === 'profile') {
    await saveProfile();
  } else if (currentTab === 'password') {
    await changePassword();
  }
}

async function saveProfile() {
  const newUsername = document.getElementById('editUsername').value.trim();
  const fileInput = document.getElementById('editPfp');
  let pfpData = currentPfp;
  
  if (fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      pfpData = e.target.result;
      await doSaveProfile(newUsername, pfpData);
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    await doSaveProfile(newUsername, pfpData);
  }
}

async function doSaveProfile(newUsername, pfpData) {
  try {
    const res = await fetch('/profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, username: newUsername || null, pfp: pfpData || null })
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('Error: ' + (err.detail || 'Failed to update profile'));
      return;
    }
    
    const data = await res.json();
    
    // Update local storage
    localStorage.setItem('token', data.access_token);
    localStorage.setItem('username', data.username);
    if (data.pfp) localStorage.setItem('pfp', data.pfp);
    
    // Update UI
    currentUsername = data.username;
    currentPfp = data.pfp || '';
    currentUserEl.textContent = currentUsername;
    if (currentPfp) {
      pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;
    }
    
    closeProfileModal();
    alert('Profile updated successfully!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function changePassword() {
  const oldPw = document.getElementById('oldPassword').value;
  const newPw = document.getElementById('newPassword').value;
  const confirmPw = document.getElementById('confirmPassword').value;
  
  if (!oldPw || !newPw || !confirmPw) {
    alert('Please fill all password fields');
    return;
  }
  
  if (newPw !== confirmPw) {
    alert('New passwords do not match');
    return;
  }
  
  if (newPw.length < 6) {
    alert('New password must be at least 6 characters');
    return;
  }
  
  try {
    const res = await fetch('/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, old_password: oldPw, new_password: newPw })
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('Error: ' + (err.detail || 'Failed to change password'));
      return;
    }
    
    document.getElementById('oldPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    alert('Password changed successfully!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('username');
  localStorage.removeItem('pfp');
  if (ws) ws.close();
  window.location.href = '/login.html';
}

// Initialize with sample data for demo
function initSampleData() {
  // Set main chat avatar
  document.getElementById('main-chat-avatar').style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/2455/2455300.png")';
  
  // Set current chat avatar
  currentChatAvatarEl.style.backgroundImage = 'url("https://cdn-icons-png.flaticon.com/512/2455/2455300.png")';
  
  // Add some sample online users
  setTimeout(() => {
    const sampleUsers = [
      { username: 'ShadowUser', pfp: 'https://i.pravatar.cc/150?img=1' },
      { username: 'DarkKnight', pfp: 'https://i.pravatar.cc/150?img=3' },
      { username: 'Midnight', pfp: 'https://i.pravatar.cc/150?img=4' },
      { username: 'Phantom', pfp: 'https://i.pravatar.cc/150?img=5' },
      { username: 'Viper', pfp: 'https://i.pravatar.cc/150?img=6' }
    ];
    
    sampleUsers.forEach(user => {
      const item = document.createElement('div');
      item.className = 'chat-item';
      item.onclick = () => startPrivateChat(user.username);
      item.innerHTML = `
        <div class="chat-item-avatar" style="background-image: url('${user.pfp}')"></div>
        <div class="chat-item-info">
          <div class="chat-item-header">
            <div class="chat-item-name">${user.username}</div>
            <div class="chat-item-time">Online</div>
          </div>
          <div class="chat-item-preview">Click to start chat</div>
        </div>
      `;
      onlineUsersList.appendChild(item);
    });
    
    updateOnlineCount(sampleUsers.length + 1); // +1 for current user
  }, 1000);
}

// Connect on load
connectWS();
initSampleData();
</script>
</body>
</html>
