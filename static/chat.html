<!DOCTYPE html>
<html>
<head>
<title>Sinister Chat</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin: 0; 
    padding: 0; 
    display: flex; 
    height: 100vh; 
    background-color: #121212;
    color: #e0e0e0;
  }
  
  /* Sidebar */
  .sidebar { 
    width: 280px; 
    background: #1e1e1e; 
    border-right: 1px solid #2d2d2d; 
    display: flex; 
    flex-direction: column; 
  }
  .sidebar-header { 
    padding: 15px; 
    border-bottom: 1px solid #2d2d2d; 
  }
  .sidebar-header h3 { 
    margin: 0 0 10px 0; 
    color: #ffffff; 
    font-size: 18px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .user-profile { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 15px; 
  }
  .pfp-avatar { 
    width: 40px; 
    height: 40px; 
    background: #333; 
    background-size: cover; 
    background-position: center; 
    border-radius: 50%; /* Made circles */
    border: 2px solid #444; 
    cursor: pointer; 
    flex-shrink: 0; 
  }
  .user-name { 
    font-weight: 600; 
    flex: 1; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    color: #ffffff;
  }
  
  .sidebar-buttons { 
    display: flex; 
    gap: 5px; 
    flex-wrap: wrap; 
  }
  .sidebar-buttons button { 
    flex: 1; 
    min-width: 80px; 
    padding: 8px; 
    background: #2d2d2d; 
    color: #ffffff; 
    border: 1px solid #3d3d3d; 
    cursor: pointer; 
    font-size: 0.9em; 
  }
  .sidebar-buttons .logout-btn { background: #5a1a1a; border-color: #6a2a2a; }

  .chat-section { flex: 1; display: flex; flex-direction: column; }
  .chat-header { padding: 15px; border-bottom: 1px solid #2d2d2d; background: #1a1a1a; }
  .chat-header h2 { margin: 0; color: #ffffff; font-size: 20px; text-transform: uppercase; }
  
  .chats-list { flex: 1; overflow-y: auto; padding: 10px; background: #1a1a1a; }
  .chat-item { 
    padding: 12px; 
    background: #252525; 
    margin-bottom: 8px; 
    border-left: 3px solid #3d3d3d; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    gap: 10px;
  }
  .chat-item.active { background: #1a3d1a; border-left-color: #4CAF50; }
  .chat-item-avatar { width: 35px; height: 35px; background: #444; border-radius: 50%; background-size: cover; flex-shrink: 0; }
  .chat-item-info { display: flex; flex-direction: column; }
  .chat-item-name { font-weight: 600; color: #fff; font-size: 0.9em; }
  .chat-item-type { font-size: 0.75em; color: #888; }

  /* Messages Area */
  .messages-area { flex: 1; display: flex; flex-direction: column; padding: 15px; background: #121212; }
  #chat { flex: 1; border: 1px solid #2d2d2d; overflow-y: auto; padding: 10px; background: #0f0f0f; margin-bottom: 10px; list-style: none; }
  
  /* Message Bubbles with Avatars */
  #chat li { 
    margin: 12px 0; 
    padding: 10px; 
    background: #1a1a1a; 
    border-radius: 4px;
    display: flex; 
    align-items: flex-start; 
    gap: 10px;
  }
  .msg-pfp { width: 30px; height: 30px; border-radius: 50%; background: #333; background-size: cover; flex-shrink: 0; }
  .msg-content { flex: 1; }
  .username { font-weight: 600; color: #4dabf7; margin-right: 5px; }
  .timestamp { font-size: 0.7em; color: #555; float: right; }

  .input-area { display: flex; gap: 5px; }
  #msg { flex: 1; padding: 12px; border: 1px solid #2d2d2d; background: #1a1a1a; color: #e0e0e0; }
  .input-area button { padding: 12px 20px; background: #2d2d2d; color: white; border: 1px solid #3d3d3d; cursor: pointer; font-weight: 600; }
  
  .status { font-size: 0.8em; padding: 5px; text-align: center; }
  .status.error { color: #f44336; }
  .status.ok { color: #4CAF50; }

  /* Modal */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; align-items: center; justify-content: center; }
  .modal.active { display: flex; }
  .modal-content { background: #1e1e1e; padding: 20px; border: 1px solid #2d2d2d; width: 90%; max-width: 400px; }
  .modal-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #2d2d2d; }
  .modal-tab { padding: 10px; cursor: pointer; background: none; border: none; color: #aaa; }
  .modal-tab.active { color: #fff; border-bottom: 2px solid #4CAF50; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .form-group { margin-bottom: 15px; }
  .form-group label { display: block; margin-bottom: 5px; font-size: 0.9em; }
  .form-group input { width: 100%; padding: 10px; background: #252525; border: 1px solid #333; color: #fff; }
  .preview-pfp { width: 60px; height: 60px; border-radius: 50%; background: #333; background-size: cover; margin-bottom: 10px; }
  .search-results { max-height: 150px; overflow-y: auto; background: #252525; }
  .search-result-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <h3>Sinister Chat</h3>
    <div class="user-profile">
      <span id="pfp-avatar" class="pfp-avatar" onclick="openProfileModal()"></span>
      <div class="user-name" id="current-user">Loading...</div>
    </div>
    <div class="sidebar-buttons">
      <button onclick="openProfileModal()">Settings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  
  <div class="chat-section">
    <div class="chat-header">
      <h2>Messages</h2>
    </div>
    <div class="chats-list" id="active-chats-list">
      <div class="chat-item active" onclick="switchChat('main', 'Main Chat')">
        <div class="chat-item-avatar" style="background-image: url('https://cdn-icons-png.flaticon.com/512/2583/2583157.png')"></div>
        <div class="chat-item-info">
          <div class="chat-item-name">Main Chat</div>
          <div class="chat-item-type">Public Room</div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="status" id="status">Connecting...</div>
</div>

<div class="messages-area">
  <ul id="chat"></ul>
  <div class="input-area">
    <input id="msg" placeholder="Type a message..." disabled />
    <button id="sendBtn" onclick="send()" disabled>Send</button>
  </div>
</div>

<div id="profileModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Settings</div>
    <div class="modal-tabs">
      <button class="modal-tab active" id="tab-profile" onclick="switchTab('profile')">Profile</button>
      <button class="modal-tab" id="tab-password" onclick="switchTab('password')">Password</button>
      <button class="modal-tab" id="tab-private" onclick="switchTab('private')">Direct Message</button>
    </div>
    
    <div id="profile" class="tab-content active">
      <div class="preview-pfp" id="previewPfp"></div>
      <div class="form-group">
        <label>Username</label>
        <input id="editUsername" type="text" />
      </div>
      <div class="form-group">
        <label>Profile Picture</label>
        <input id="editPfp" type="file" accept="image/*" onchange="previewImage()" />
      </div>
    </div>
    
    <div id="password" class="tab-content">
      <div class="form-group"><input id="oldPassword" type="password" placeholder="Old Password" /></div>
      <div class="form-group"><input id="newPassword" type="password" placeholder="New Password" /></div>
      <div class="form-group"><input id="confirmPassword" type="password" placeholder="Confirm Password" /></div>
    </div>
    
    <div id="private" class="tab-content">
      <div class="form-group">
        <label>Search User</label>
        <input id="searchUser" type="text" placeholder="Type username..." onkeyup="searchUsers()" />
      </div>
      <div id="searchResults" class="search-results"></div>
    </div>
    
    <div style="display:flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
      <button onclick="closeProfileModal()">Close</button>
      <button id="actionBtn" onclick="handleModalAction()">Save</button>
    </div>
  </div>
</div>

<script>
let currentUsername = localStorage.getItem('username') || 'Anonymous';
let currentPfp = localStorage.getItem('pfp') || '';
let currentChatId = 'main'; // Track which chat window we are in
const token = localStorage.getItem('token');

if (!token) window.location.href = '/login.html';

const chat = document.getElementById('chat');
const msg = document.getElementById('msg');
const statusEl = document.getElementById('status');
const currentUserEl = document.getElementById('current-user');
const pfpAvatarEl = document.getElementById('pfp-avatar');

currentUserEl.textContent = currentUsername;
if (currentPfp) pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;

// WebSocket Setup
const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';
let ws = null;

function connectWS() {
    ws = new WebSocket(`${wsProtocol}://${location.host}/ws?token=${encodeURIComponent(token)}`);
    ws.onopen = () => {
        statusEl.textContent = 'âœ“ Connected';
        statusEl.className = 'status ok';
        msg.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        loadMessages();
    };
    ws.onmessage = e => {
        const data = JSON.parse(e.data);
        if (data.type === 'message') {
            // Only show message if it's for the current room
            // (Assuming your backend sends a target_user or room_id)
            addMessage(data.data.username, data.data.text, data.data.timestamp, data.data.pfp);
        }
    };
}

function addMessage(user, text, timestamp, pfp) {
    const li = document.createElement('li');
    const userPfp = pfp || 'https://via.placeholder.com/30';
    const time = timestamp ? new Date(timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
    
    li.innerHTML = `
        <div class="msg-pfp" style="background-image: url('${userPfp}')"></div>
        <div class="msg-content">
            <span class="timestamp">${time}</span>
            <div class="username">${user}</div>
            <div>${text}</div>
        </div>
    `;
    chat.appendChild(li);
    chat.scrollTop = chat.scrollHeight;
}

function send() {
    if (!msg.value.trim() || !ws) return;
    const payload = {
        type: 'message',
        content: msg.value,
        target: currentChatId // 'main' or a username
    };
    ws.send(JSON.stringify(payload));
    msg.value = '';
}

// Sidebar & Private Chat Logic
function switchChat(id, name, pfp) {
    currentChatId = id;
    chat.innerHTML = ''; // Clear chat to simulate switching rooms
    addEvent(`Switched to ${name}`);
    
    // Update active UI
    document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
    // If it's a new DM, we might need to find the specific element
    event.currentTarget.classList.add('active');
    
    if(id !== 'main') {
        loadPrivateMessages(id);
    } else {
        loadMessages();
    }
}

function openPrivateChat(targetUser, targetPfp) {
    const list = document.getElementById('active-chats-list');
    
    // Check if already in sidebar
    let existing = document.getElementById(`chat-with-${targetUser}`);
    if (!existing) {
        const div = document.createElement('div');
        div.id = `chat-with-${targetUser}`;
        div.className = 'chat-item';
        div.onclick = (e) => switchChat(targetUser, targetUser, targetPfp);
        div.innerHTML = `
            <div class="chat-item-avatar" style="background-image: url('${targetPfp || ''}')"></div>
            <div class="chat-item-info">
                <div class="chat-item-name">${targetUser}</div>
                <div class="chat-item-type">Direct Message</div>
            </div>
        `;
        list.appendChild(div);
    }
    closeProfileModal();
    switchChat(targetUser, targetUser, targetPfp);
}

// Modal & Tab Logic
function switchTab(tab) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    document.getElementById('tab-' + tab).classList.add('active');
    document.getElementById('actionBtn').style.display = (tab === 'private') ? 'none' : 'block';
}

async function searchUsers() {
    const q = document.getElementById('searchUser').value.trim();
    if (q.length < 2) return;
    try {
        const res = await fetch(`/search-users?q=${encodeURIComponent(q)}&token=${encodeURIComponent(token)}`);
        const users = await res.json();
        const resultsEl = document.getElementById('searchResults');
        resultsEl.innerHTML = '';
        users.forEach(u => {
            const d = document.createElement('div');
            d.className = 'search-result-item';
            d.innerHTML = `<strong>${u.username}</strong>`;
            d.onclick = () => openPrivateChat(u.username, u.pfp);
            resultsEl.appendChild(d);
        });
    } catch(e) {}
}

// Reuse your existing profile/password logic here...
function openProfileModal() { document.getElementById('profileModal').classList.add('active'); }
function closeProfileModal() { document.getElementById('profileModal').classList.remove('active'); }
function addEvent(txt) { const li = document.createElement('li'); li.className='status'; li.textContent=txt; chat.appendChild(li); }
function logout() { localStorage.clear(); window.location.href = '/login.html'; }

msg.addEventListener('keypress', (e) => { if (e.key === 'Enter') send(); });

connectWS();
</script>
</body>
</html>
