<!DOCTYPE html>
<html>
<head>
<title>Sinister Chat</title>
<style>
  * { box-sizing: border-box; }
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    margin: 0; 
    padding: 0; 
    display: flex; 
    height: 100vh; 
    background-color: #121212;
    color: #e0e0e0;
  }
  
  /* Sidebar */
  .sidebar { 
    width: 280px; 
    background: #1e1e1e; 
    border-right: 1px solid #2d2d2d; 
    display: flex; 
    flex-direction: column; 
  }
  .sidebar-header { 
    padding: 15px; 
    border-bottom: 1px solid #2d2d2d; 
  }
  .sidebar-header h3 { 
    margin: 0 0 10px 0; 
    color: #ffffff; 
    font-size: 18px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  /* User Profile */
  .user-profile { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 15px; 
  }
  .pfp-avatar { 
    width: 40px; 
    height: 40px; 
    background: #333; 
    background-size: cover; 
    background-position: center; 
    border: 2px solid #444; 
    cursor: pointer; 
    flex-shrink: 0; 
  }
  .user-name { 
    font-weight: 600; 
    flex: 1; 
    overflow: hidden; 
    text-overflow: ellipsis; 
    color: #ffffff;
  }
  
  /* Buttons */
  .sidebar-buttons { 
    display: flex; 
    gap: 5px; 
    flex-wrap: wrap; 
  }
  button {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .sidebar-buttons button { 
    flex: 1; 
    min-width: 80px; 
    padding: 8px; 
    background: #2d2d2d; 
    color: #ffffff; 
    border: 1px solid #3d3d3d; 
    cursor: pointer; 
    font-size: 0.9em; 
    transition: background-color 0.2s;
  }
  .sidebar-buttons button:hover { 
    background: #3d3d3d; 
  }
  .sidebar-buttons .logout-btn { 
    background: #5a1a1a; 
    border-color: #6a2a2a;
  }
  .sidebar-buttons .logout-btn:hover { 
    background: #6a2a2a; 
  }
  
  /* Chat Section */
  .chat-section { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
  }
  .chat-header { 
    padding: 15px; 
    border-bottom: 1px solid #2d2d2d; 
    background: #1a1a1a; 
  }
  .chat-header h2 { 
    margin: 0; 
    color: #ffffff;
    font-size: 22px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }
  
  /* Chats List */
  .chats-list { 
    flex: 1; 
    overflow-y: auto; 
    padding: 10px; 
    background: #1a1a1a;
  }
  .chat-item { 
    padding: 12px; 
    background: #252525; 
    margin-bottom: 8px; 
    border-left: 3px solid #3d3d3d; 
    cursor: pointer; 
    transition: background-color 0.2s;
  }
  .chat-item:hover { 
    background: #2d2d2d; 
  }
  .chat-item.active { 
    background: #1a3d1a; 
    border-left-color: #4CAF50; 
  }
  .chat-item-header { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    margin-bottom: 5px; 
  }
  .chat-item-avatar { 
    width: 30px; 
    height: 30px; 
    background: #333; 
    background-size: cover; 
    flex-shrink: 0; 
  }
  .chat-item-name { 
    font-weight: 600; 
    color: #ffffff;
  }
  .chat-item-type { 
    font-size: 0.8em; 
    color: #888; 
  }
  
  /* Messages Area */
  .messages-area { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    padding: 15px; 
    background: #121212;
  }
  #chat { 
    flex: 1; 
    border: 1px solid #2d2d2d; 
    overflow-y: auto; 
    padding: 10px; 
    background: #0f0f0f; 
    margin-bottom: 10px; 
    list-style: none;
  }
  #chat li { 
    margin: 8px 0; 
    padding: 10px; 
    background: #1a1a1a; 
    border-left: 3px solid #3d3d3d; 
    transition: background-color 0.2s;
  }
  .username { 
    font-weight: 600; 
    color: #4dabf7; 
  }
  .timestamp { 
    font-size: 0.75em; 
    color: #777; 
    margin-left: 10px; 
    float: right;
  }
  .typing { 
    font-style: italic; 
    color: #777; 
    padding: 8px;
  }
  .event { 
    background: #1a2d1a; 
    border-left-color: #2e7d32; 
    font-size: 0.85em; 
    color: #aaa; 
    text-align: center;
  }
  
  /* Input Area */
  .input-area { 
    display: flex; 
    gap: 5px; 
  }
  #msg { 
    flex: 1; 
    padding: 12px; 
    border: 1px solid #2d2d2d; 
    background: #1a1a1a; 
    color: #e0e0e0; 
    font-size: 14px;
  }
  #msg::placeholder {
    color: #777;
  }
  .input-area button { 
    padding: 12px 20px; 
    background: #2d2d2d; 
    color: white; 
    border: 1px solid #3d3d3d; 
    cursor: pointer; 
    font-weight: 600;
    transition: background-color 0.2s;
  }
  .input-area button:hover { 
    background: #3d3d3d; 
  }
  
  /* Header */
  .header {
    display: none; /* Hidden since we have sidebar now */
  }
  
  /* Status */
  .status { 
    font-size: 0.85em; 
    margin-top: 5px; 
    padding: 5px;
  }
  .status.error { 
    color: #f44336; 
    background: #2a1a1a;
    border: 1px solid #3d2a2a;
  }
  .status.ok { 
    color: #4CAF50; 
    background: #1a2a1a;
    border: 1px solid #2a3a2a;
  }
  
  /* Modal */
  .modal { 
    display: none; 
    position: fixed; 
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0,0,0,0.8); 
    z-index: 999; 
  }
  .modal.active { 
    display: flex; 
    align-items: center; 
    justify-content: center; 
  }
  .modal-content { 
    background: #1e1e1e; 
    padding: 20px; 
    border: 1px solid #2d2d2d; 
    width: 90%; 
    max-width: 400px; 
    max-height: 80vh; 
    overflow-y: auto; 
  }
  .modal-header { 
    font-size: 1.2em; 
    font-weight: 600; 
    margin-bottom: 15px; 
    color: #ffffff;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .form-group { 
    margin-bottom: 15px; 
  }
  .form-group label { 
    display: block; 
    margin-bottom: 5px; 
    font-weight: 600; 
    color: #cccccc;
  }
  .form-group input { 
    width: 100%; 
    padding: 10px; 
    border: 1px solid #2d2d2d; 
    background: #252525; 
    color: #e0e0e0; 
    box-sizing: border-box; 
  }
  .form-group input[type="file"] { 
    padding: 8px; 
  }
  .preview-pfp { 
    width: 80px; 
    height: 80px; 
    background: #333; 
    background-size: cover; 
    background-position: center; 
    margin: 10px auto; 
    border: 2px solid #444; 
  }
  .modal-buttons { 
    display: flex; 
    gap: 10px; 
    justify-content: flex-end; 
    margin-top: 20px; 
  }
  .modal-buttons button { 
    margin: 0; 
    padding: 10px 15px; 
  }
  .btn-cancel { 
    background: #333; 
    color: white; 
    border: 1px solid #444; 
    cursor: pointer; 
  }
  .btn-cancel:hover { 
    background: #444; 
  }
  .modal-tabs { 
    display: flex; 
    gap: 0; 
    margin-bottom: 15px; 
    border-bottom: 1px solid #2d2d2d; 
  }
  .modal-tab { 
    padding: 10px 15px; 
    cursor: pointer; 
    background: #252525; 
    border: 1px solid #2d2d2d; 
    border-bottom: none;
    color: #aaa;
    transition: all 0.2s;
  }
  .modal-tab.active { 
    background: #1e1e1e; 
    color: #ffffff; 
    border-bottom: 1px solid #1e1e1e;
    margin-bottom: -1px;
  }
  .tab-content { 
    display: none; 
  }
  .tab-content.active { 
    display: block; 
  }
  .search-results { 
    border: 1px solid #2d2d2d; 
    max-height: 200px; 
    overflow-y: auto; 
    margin-top: 10px; 
    background: #252525;
  }
  .search-result-item { 
    padding: 12px; 
    border-bottom: 1px solid #333; 
    cursor: pointer; 
    color: #cccccc;
    transition: background-color 0.2s;
  }
  .search-result-item:hover { 
    background: #2d2d2d; 
  }
  
  /* Scrollbar Styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #1a1a1a;
  }
  ::-webkit-scrollbar-thumb {
    background: #333;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #444;
  }
</style>
</head>
<body>
<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <h3>Sinister Chat</h3>
    <div class="user-profile">
      <span id="pfp-avatar" class="pfp-avatar" onclick="openProfileModal()"></span>
      <div class="user-name" id="current-user">Loading...</div>
    </div>
    <div class="sidebar-buttons">
      <button onclick="openProfileModal()">Settings</button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>
  
  <div class="chat-section">
    <div class="chat-header">
      <h2>Messages</h2>
    </div>
    <div class="chats-list">
      <!-- Chat items will be populated here -->
      <div class="chat-item active">
        <div class="chat-item-header">
          <div class="chat-item-avatar"></div>
          <div class="chat-item-name">Main Chat</div>
        </div>
        <div class="chat-item-type">Public Room</div>
      </div>
    </div>
  </div>
  
  <div class="status" id="status">Connecting...</div>
</div>

<!-- Main Chat Area -->
<div class="messages-area">
  <ul id="chat"></ul>
  
  <div class="input-area">
    <input id="msg" placeholder="Type a message..." disabled />
    <button id="sendBtn" onclick="send()" disabled>Send</button>
  </div>
</div>

<!-- Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">Settings</div>
    
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('profile')">Profile</button>
      <button class="modal-tab" onclick="switchTab('password')">Password</button>
      <button class="modal-tab" onclick="switchTab('private')">Private Chat</button>
    </div>
    
    <!-- Profile Tab -->
    <div id="profile" class="tab-content active">
      <div class="preview-pfp" id="previewPfp"></div>
      <div class="form-group">
        <label for="editUsername">Username</label>
        <input id="editUsername" type="text" placeholder="Enter new username" />
      </div>
      <div class="form-group">
        <label for="editPfp">Profile Picture (PNG/JPG)</label>
        <input id="editPfp" type="file" accept="image/*" onchange="previewImage()" />
      </div>
    </div>
    
    <!-- Password Tab -->
    <div id="password" class="tab-content">
      <div class="form-group">
        <label for="oldPassword">Old Password</label>
        <input id="oldPassword" type="password" placeholder="Enter old password" />
      </div>
      <div class="form-group">
        <label for="newPassword">New Password</label>
        <input id="newPassword" type="password" placeholder="Enter new password" />
      </div>
      <div class="form-group">
        <label for="confirmPassword">Confirm Password</label>
        <input id="confirmPassword" type="password" placeholder="Confirm new password" />
      </div>
    </div>
    
    <!-- Private Chat Tab -->
    <div id="private" class="tab-content">
      <div class="form-group">
        <label for="searchUser">Search User</label>
        <input id="searchUser" type="text" placeholder="Type username..." onkeyup="searchUsers()" />
      </div>
      <div id="searchResults" class="search-results"></div>
    </div>
    
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeProfileModal()">Close</button>
      <button id="actionBtn" onclick="handleModalAction()">Save</button>
    </div>
  </div>
</div>

<script>
// All your JavaScript functions remain exactly the same
// I've only changed the HTML structure and CSS styling

const chat = document.getElementById('chat');
const msg = document.getElementById('msg');
const statusEl = document.getElementById('status');
const countEl = document.getElementById('count');
const currentUserEl = document.getElementById('current-user');
const pfpAvatarEl = document.getElementById('pfp-avatar');

let currentUsername = 'Anonymous';
let currentPfp = '';
let typingTimeout = null;
let ws = null;

// Check auth
const token = localStorage.getItem('token');
const savedUsername = localStorage.getItem('username');
const savedPfp = localStorage.getItem('pfp');

if (!token) {
  window.location.href = '/login.html';
}

currentUsername = savedUsername || 'Anonymous';
currentPfp = savedPfp || '';
currentUserEl.textContent = currentUsername;
if (currentPfp) {
  pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;
}

const wsProtocol = location.protocol === 'https:' ? 'wss' : 'ws';

function connectWS() {
  try {
    const url = `${wsProtocol}://${location.host}/ws?token=${encodeURIComponent(token)}`;
    console.log('Connecting to:', url);
    ws = new WebSocket(url);

    ws.onopen = () => {
      console.log('WebSocket connected');
      statusEl.textContent = '✓ Connected';
      statusEl.className = 'status ok';
      msg.disabled = false;
      document.getElementById('sendBtn').disabled = false;
      loadMessages();
    };

    ws.onmessage = e => {
      try {
        const data = JSON.parse(e.data);
        const type = data.type;
        const info = data.data;

        if (type === 'message') {
          addMessage(info.username, info.text, info.timestamp);
        } else if (type === 'user_typing') {
          showTyping(info.username);
        } else if (type === 'user_joined') {
          addEvent(`${info.username} joined the chat`);
          countEl.textContent = info.count;
        } else if (type === 'user_left') {
          addEvent(`${info.username} left the chat`);
          countEl.textContent = info.count;
        } else if (type === 'username_changed') {
          addEvent(`${info.old} is now ${info.new}`);
        }
      } catch (err) {
        console.error('Error parsing message:', err);
      }
    };

    ws.onclose = () => {
      console.log('WebSocket closed');
      statusEl.textContent = '✗ Disconnected';
      statusEl.className = 'status error';
      msg.disabled = true;
      document.getElementById('sendBtn').disabled = true;
    };

    ws.onerror = (e) => {
      console.error('WebSocket error:', e);
      statusEl.textContent = '✗ Connection error: ' + (e.message || 'unknown');
      statusEl.className = 'status error';
    };
  } catch (e) {
    console.error('Failed to create WebSocket:', e);
    statusEl.textContent = '✗ Connection failed: ' + e.message;
    statusEl.className = 'status error';
  }
}

function addMessage(user, text, timestamp) {
  const li = document.createElement('li');
  const time = timestamp ? new Date(timestamp).toLocaleTimeString() : '';
  li.innerHTML = `<span class="username">${user}:</span> ${text} <span class="timestamp">${time}</span>`;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
}

function addEvent(text) {
  const li = document.createElement('li');
  li.className = 'event';
  li.textContent = text;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
}

function showTyping(user) {
  const existing = Array.from(chat.children).find(li => li.classList.contains('typing'));
  if (existing) existing.remove();
  
  const li = document.createElement('li');
  li.className = 'typing';
  li.textContent = `${user} is typing...`;
  chat.appendChild(li);
  chat.scrollTop = chat.scrollHeight;
  
  setTimeout(() => li.remove(), 2000);
}

async function loadMessages() {
  try {
    const res = await fetch('/messages');
    if (!res.ok) {
      console.error('Failed to load messages:', res.status);
      return;
    }
    const data = await res.json();
    data.forEach(m => {
      addMessage(m.username, m.text, '');
    });
    chat.scrollTop = chat.scrollHeight;
  } catch (e) {
    console.error('Error loading messages:', e);
  }
}

function send() {
  if (!msg.value.trim()) {
    return;
  }
  
  if (!ws || ws.readyState !== WebSocket.OPEN) {
    statusEl.textContent = '✗ Not connected';
    statusEl.className = 'status error';
    return;
  }
  
  ws.send(JSON.stringify({ type: 'message', content: msg.value }));
  msg.value = '';
  
  if (typingTimeout) clearTimeout(typingTimeout);
}

msg.addEventListener('input', () => {
  if (ws && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({ type: 'typing' }));
  }
  
  if (typingTimeout) clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {}, 2000);
});

msg.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') send();
});

// Profile management
let currentTab = 'profile';

function switchTab(tab) {
  currentTab = tab;
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.modal-tab').forEach(el => el.classList.remove('active'));
  document.getElementById(tab).classList.add('active');
  document.event.target.classList.add('active');
  
  const btn = document.getElementById('actionBtn');
  if (tab === 'profile') {
    btn.textContent = 'Save';
  } else if (tab === 'password') {
    btn.textContent = 'Change Password';
  } else {
    btn.style.display = 'none';
  }
}

function openProfileModal() {
  const modal = document.getElementById('profileModal');
  modal.classList.add('active');
  document.getElementById('editUsername').value = currentUsername;
  const preview = document.getElementById('previewPfp');
  if (currentPfp) {
    preview.style.backgroundImage = `url('${currentPfp}')`;
  } else {
    preview.style.background = '#333';
  }
}

function closeProfileModal() {
  document.getElementById('profileModal').classList.remove('active');
  document.getElementById('editPfp').value = '';
  document.getElementById('oldPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  document.getElementById('searchUser').value = '';
  document.getElementById('searchResults').innerHTML = '';
  document.getElementById('actionBtn').style.display = 'block';
}

function previewImage() {
  const fileInput = document.getElementById('editPfp');
  const preview = document.getElementById('previewPfp');
  const file = fileInput.files[0];
  
  if (file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      preview.style.backgroundImage = `url('${e.target.result}')`;
    };
    reader.readAsDataURL(file);
  }
}

async function searchUsers() {
  const q = document.getElementById('searchUser').value.trim();
  if (!q || q.length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }
  
  try {
    const res = await fetch(`/search-users?q=${encodeURIComponent(q)}&token=${encodeURIComponent(token)}`);
    if (!res.ok) return;
    const results = await res.json();
    
    const resultsEl = document.getElementById('searchResults');
    resultsEl.innerHTML = '';
    results.forEach(user => {
      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.innerHTML = `<span>${user.username}</span>`;
      item.onclick = () => openPrivateChat(user.username);
      resultsEl.appendChild(item);
    });
  } catch (e) {
    console.error(e);
  }
}

async function openPrivateChat(withUser) {
  try {
    const res = await fetch('/private-chats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, with_user: withUser })
    });
    if (!res.ok) {
      alert('Error creating chat');
      return;
    }
    const data = await res.json();
    closeProfileModal();
    alert(`Opened private chat with ${withUser}! (Coming soon - feature under development)`);
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function handleModalAction() {
  if (currentTab === 'profile') {
    await saveProfile();
  } else if (currentTab === 'password') {
    await changePassword();
  }
}

async function saveProfile() {
  const newUsername = document.getElementById('editUsername').value.trim();
  const fileInput = document.getElementById('editPfp');
  let pfpData = currentPfp;
  
  if (fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = async (e) => {
      pfpData = e.target.result;
      await doSaveProfile(newUsername, pfpData);
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    await doSaveProfile(newUsername, pfpData);
  }
}

async function doSaveProfile(newUsername, pfpData) {
  try {
    const res = await fetch('/profile', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, username: newUsername || null, pfp: pfpData || null })
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('Error: ' + (err.detail || 'Failed to update profile'));
      return;
    }
    
    const data = await res.json();
    
    // Update local storage
    localStorage.setItem('token', data.access_token);
    localStorage.setItem('username', data.username);
    if (data.pfp) localStorage.setItem('pfp', data.pfp);
    
    // Update UI
    currentUsername = data.username;
    currentPfp = data.pfp || '';
    currentUserEl.textContent = currentUsername;
    if (currentPfp) {
      pfpAvatarEl.style.backgroundImage = `url('${currentPfp}')`;
    }
    
    closeProfileModal();
    alert('Profile updated successfully!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

async function changePassword() {
  const oldPw = document.getElementById('oldPassword').value;
  const newPw = document.getElementById('newPassword').value;
  const confirmPw = document.getElementById('confirmPassword').value;
  
  if (!oldPw || !newPw || !confirmPw) {
    alert('Please fill all password fields');
    return;
  }
  
  if (newPw !== confirmPw) {
    alert('New passwords do not match');
    return;
  }
  
  if (newPw.length < 6) {
    alert('New password must be at least 6 characters');
    return;
  }
  
  try {
    const res = await fetch('/change-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ token, old_password: oldPw, new_password: newPw })
    });
    
    if (!res.ok) {
      const err = await res.json();
      alert('Error: ' + (err.detail || 'Failed to change password'));
      return;
    }
    
    document.getElementById('oldPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
    alert('Password changed successfully!');
  } catch (e) {
    alert('Error: ' + e.message);
  }
}

function logout() {
  localStorage.removeItem('token');
  localStorage.removeItem('username');
  if (ws) ws.close();
  window.location.href = '/login.html';
}

// Connect on load
connectWS();
</script>
</body>
</html>
